#!/usr/bin/env python3

import time
from getpass import getpass
from dms2021client.data.config import ClientConfiguration
from dms2021client.data.rest import AuthService
from dms2021client.data.rest.exc import InvalidCredentialsError, UnauthorizedError
from dms2021client.presentation import ServiciosEstado, MenuEstado

class ManejadorPagina:

    def __init__(self):
        self.cfg: ClientConfiguration = ClientConfiguration()
        self.cfg.load_from_file(self.cfg.default_config_file())
        self.auth_service: AuthService = AuthService(self.cfg.get_auth_service_host(), self.cfg.get_auth_service_port())
        self.session_id : str = ""
        self.login()
        opcion = MenuEstado.ejecutarPagina(self.session_id)
        while opcion != 6:
            if opcion == 0:
                MenuEstado.ejecutarPagina(self.session_id)
            elif opcion == 1:
                pass
            elif opcion == 2:
                pass
            elif opcion == 3:
                pass
            elif opcion == 4:
                pass
            elif opcion == 5:
                pass
        self.logout()
            


    def login(self):
        
        while not self.auth_service.is_running():
            time.sleep(1)
        print("\nAuthentication service up!")
        
        
        print('Press Ctrl+C to end this process.')
        print('If run as a docker container, press Ctrl+P,Ctrl+Q to detach from the container.')
        username: str = input('Username: ')
        password: str = getpass('Password: ')
        try:
            self.session_id = self.auth_service.login(username, password)
            print('Logged in successfully as ' + username + ' . Session id: ' + self.session_id)
        except InvalidCredentialsError:
            print('Wrong username and/or password. Try again.')
        except Exception as ex:
            print(ex)

    


    def logout(self):
        try:
            self.auth_service.logout(self.session_id)
            print('Logged out successfully.')
        except UnauthorizedError:
            print('Wrong session id.')
        except Exception as ex:
            print(ex)

ManejadorPagina()